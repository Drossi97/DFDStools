---
// Componente de Traductor con APIs nativas del navegador - Interfaz tipo Chat
---

<div class="w-full max-w-4xl mx-auto">
  <!-- API Warning -->
  <div id="apiWarning" class="bg-yellow-50 border border-yellow-200 text-yellow-800 px-4 py-3 rounded-lg mb-4 hidden">
    ⚠️ APIs nativas de traducción no disponibles. Funcionalidad limitada.
  </div>

  <!-- Selector de idiomas compacto -->
  <section class="max-w-lg mx-auto mb-4">
    <div class="flex items-center justify-center gap-3">
      <div class="flex items-center gap-2">
        <span class="text-sm text-gray-600">De:</span>
        <select 
          id="sourceLanguage"
          class="px-3 py-1.5 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[#002B45] focus:border-transparent"
        >
          <option value="auto">Detectar</option>
          <option value="en">Inglés</option>
          <option value="es" selected>Español</option>
          <option value="fr">Francés</option>
          <option value="de">Alemán</option>
          <option value="it">Italiano</option>
          <option value="pt">Portugués</option>
          <option value="ru">Ruso</option>
          <option value="ja">Japonés</option>
          <option value="zh">Chino</option>
          <option value="ar">Árabe</option>
        </select>
      </div>

      <button 
        id="swapLanguages"
        class="p-2 hover:bg-gray-100 rounded-full transition-colors"
        title="Intercambiar idiomas"
      >
        <svg class="w-5 h-5 text-[#002B45]" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M7 16V4M7 4L3 8M7 4L11 8M17 8V20M17 20L21 16M17 20L13 16" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>

      <div class="flex items-center gap-2">
        <span class="text-sm text-gray-600">A:</span>
        <select 
          id="targetLanguage"
          class="px-3 py-1.5 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[#002B45] focus:border-transparent"
        >
          <option value="en" selected>Inglés</option>
          <option value="es">Español</option>
          <option value="fr">Francés</option>
          <option value="de">Alemán</option>
          <option value="it">Italiano</option>
          <option value="pt">Portugués</option>
          <option value="ru">Ruso</option>
          <option value="ja">Japonés</option>
          <option value="zh">Chino</option>
          <option value="ar">Árabe</option>
        </select>
      </div>
    </div>
  </section>

  <!-- Chat Area -->
  <section class="bg-white rounded-lg shadow-sm border border-gray-300 overflow-hidden flex flex-col" style="height: 500px;">
    <!-- Messages Container -->
    <div id="chatMessages" class="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-50">
    </div>

    <!-- Input Area -->
    <div class="border-t border-gray-300 bg-white p-4">
      <div class="flex gap-2 items-stretch">
        <button 
          id="micButton"
          class="p-3 hover:bg-gray-100 rounded-full transition-colors flex-shrink-0 self-center"
          title="Reconocimiento de voz"
        >
          <svg class="w-5 h-5 text-gray-700" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 1a3 3 0 00-3 3v8a3 3 0 006 0V4a3 3 0 00-3-3z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M19 10v2a7 7 0 01-14 0v-2M12 19v4M8 23h8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
        
        <div class="flex-1 relative flex items-stretch">
          <textarea 
            id="inputText"
            maxlength="5000"
            rows="1"
            class="w-full px-4 border border-gray-300 rounded-md focus:outline-none focus:border-gray-400 resize-none overflow-hidden bg-white text-gray-800"
            style="min-height: 48px; line-height: 1.5; padding-top: 12px; padding-bottom: 12px;"
          ></textarea>
        </div>

        <button 
          id="sendButton"
          class="w-12 bg-[#002B45] text-white rounded-md hover:bg-[#003a5c] transition-all flex-shrink-0 disabled:bg-gray-300 disabled:cursor-not-allowed shadow-md hover:shadow-lg active:scale-95 flex items-center justify-center"
          style="min-height: 48px;"
          title="Enviar mensaje"
          disabled
        >
          <svg class="w-6 h-6" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
            <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
          </svg>
        </button>
      </div>
    </div>
  </section>
</div>

<script>
// @ts-nocheck
class ChatTranslator {
  static SUPPORTED_LANGUAGES = [
    'en', 'es', 'fr', 'de', 'it', 'pt', 'ru', 'ja', 'zh', 'ar'
  ];

  static FULL_LANGUAGES_CODES = {
    es: 'es-ES',
    en: 'en-US',
    fr: 'fr-FR',
    de: 'de-DE',
    it: 'it-IT',
    pt: 'pt-PT',
    ru: 'ru-RU',
    ja: 'ja-JP',
    zh: 'zh-CN',
    ar: 'ar-SA'
  };

  static LANGUAGE_NAMES = {
    en: 'Inglés',
    es: 'Español',
    fr: 'Francés',
    de: 'Alemán',
    it: 'Italiano',
    pt: 'Portugués',
    ru: 'Ruso',
    ja: 'Japonés',
    zh: 'Chino',
    ar: 'Árabe'
  };

  static DEFAULT_SOURCE_LANGUAGE = 'es';
  static DEFAULT_TARGET_LANGUAGE = 'en';

  constructor() {
    this.init();
    this.setupEventListeners();
    this.currentTranslator = null;
    this.currentTranslatorKey = null;
    this.currentDetector = null;
    this.messageId = 0;
  }

  init() {
    this.inputText = document.getElementById('inputText');
    this.chatMessages = document.getElementById('chatMessages');
    this.sourceLanguage = document.getElementById('sourceLanguage');
    this.targetLanguage = document.getElementById('targetLanguage');
    this.micButton = document.getElementById('micButton');
    this.sendButton = document.getElementById('sendButton');
    this.swapLanguagesButton = document.getElementById('swapLanguages');

    this.checkAPISupport();
  }

  checkAPISupport() {
    this.hasNativeTranslator = "Translator" in window;
    this.hasNativeDetector = "LanguageDetector" in window;

    if (!this.hasNativeTranslator || !this.hasNativeDetector) {
      console.warn("APIs nativas de traducción y detección de idioma NO soportadas en tu navegador.");
      this.showAPIWarning();
    } else {
      console.log('✅ APIs nativas de IA disponibles');
    }
  }

  showAPIWarning() {
    const warning = document.getElementById("apiWarning");
    if (warning) warning.classList.remove("hidden");
  }

  setupEventListeners() {
    this.inputText?.addEventListener('input', () => {
      this.updateSendButton();
      this.autoResizeTextarea();
    });

    this.inputText?.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        this.sendMessage();
      }
    });

    this.sendButton?.addEventListener('click', () => this.sendMessage());
    this.swapLanguagesButton?.addEventListener('click', () => this.swapLanguages());
    this.micButton?.addEventListener('click', () => this.startVoiceRecognition());
  }

  updateSendButton() {
    const hasText = this.inputText?.value.trim().length > 0;
    if (this.sendButton) {
      this.sendButton.disabled = !hasText;
    }
  }

  autoResizeTextarea() {
    if (this.inputText) {
      this.inputText.style.height = 'auto';
      this.inputText.style.height = this.inputText.scrollHeight + 'px';
    }
  }

  async sendMessage() {
    const text = this.inputText?.value.trim();
    if (!text) return;

    // Limpiar input
    this.inputText.value = '';
    this.updateSendButton();
    this.autoResizeTextarea();

    // Detectar y actualizar idioma si es auto
    let detectedLang = null;
    if (this.sourceLanguage?.value === 'auto') {
      detectedLang = await this.detectLanguage(text);
      this.updateDetectedLanguage(detectedLang);
    }

    // Agregar mensaje combinado con estado de traduciendo
    const messageId = this.messageId++;
    this.addCombinedMessage(text, 'Traduciendo...', messageId, true);

    try {
      const translation = await this.getTranslation(text);
      this.updateCombinedMessage(messageId, text, translation, false);
    } catch (error) {
      console.error(error);
      this.updateCombinedMessage(messageId, text, 'Error al traducir', false);
    }
  }

  addCombinedMessage(originalText, translationText, messageId, isLoading = false) {
    const messageDiv = document.createElement('div');
    // Alternar entre derecha e izquierda según el messageId
    const alignment = messageId % 2 === 0 ? 'justify-end' : 'justify-start';
    messageDiv.className = `flex ${alignment}`;
    messageDiv.id = `message-${messageId}`;
    
    const sourceLang = this.sourceLanguage?.value === 'auto' ? ChatTranslator.DEFAULT_SOURCE_LANGUAGE : this.sourceLanguage?.value;
    const targetLang = this.targetLanguage?.value;
    
    messageDiv.innerHTML = `
      <div class="max-w-[85%] min-w-[200px] bg-white border border-gray-300 rounded-lg shadow-md overflow-hidden">
        <!-- Texto Original -->
        <div class="bg-[#002B45] text-white px-4 py-3">
          <div class="text-base break-words overflow-wrap-anywhere">${originalText}</div>
        </div>
        
        <!-- Separador -->
        <div class="h-px bg-gray-300"></div>
        
        <!-- Traducción -->
        <div class="bg-gray-50 px-4 py-3">
          <div class="text-base text-gray-800 translation-text break-words overflow-wrap-anywhere">${isLoading ? '<span class="text-blue-600">' + translationText + '</span>' : translationText}</div>
        </div>
      </div>
    `;

    this.chatMessages?.appendChild(messageDiv);
    this.scrollToBottom();
  }

  updateCombinedMessage(messageId, originalText, translationText, isLoading) {
    const messageDiv = document.getElementById(`message-${messageId}`);
    if (!messageDiv) return;

    const sourceLang = this.sourceLanguage?.value === 'auto' ? ChatTranslator.DEFAULT_SOURCE_LANGUAGE : this.sourceLanguage?.value;
    const targetLang = this.targetLanguage?.value;

    messageDiv.innerHTML = `
      <div class="max-w-[85%] min-w-[200px] bg-white border border-gray-300 rounded-lg shadow-md overflow-hidden">
        <!-- Texto Original -->
        <div class="bg-[#002B45] text-white px-4 py-3">
          <div class="text-base break-words overflow-wrap-anywhere">${originalText}</div>
        </div>
        
        <!-- Separador -->
        <div class="h-px bg-gray-300"></div>
        
        <!-- Traducción -->
        <div class="bg-gray-50 px-4 py-3">
          <div class="text-base text-gray-800 translation-text break-words overflow-wrap-anywhere">${isLoading ? '<span class="text-blue-600">' + translationText + '</span>' : translationText}</div>
        </div>
      </div>
    `;

    this.scrollToBottom();
  }

  scrollToBottom() {
    if (this.chatMessages) {
      this.chatMessages.scrollTop = this.chatMessages.scrollHeight;
    }
  }

  clearChat() {
    if (this.chatMessages) {
      this.chatMessages.innerHTML = '';
    }
    this.messageId = 0;
  }

  escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  copyText(text, button) {
    navigator.clipboard.writeText(text).then(() => {
      const originalColor = button.style.color;
      button.style.color = "#34a853";
      setTimeout(() => {
        button.style.color = originalColor;
      }, 500);
    }).catch(err => {
      console.error('Error al copiar: ', err);
    });
  }

  speakText(text, languageCode) {
    const hasNativeSupportSynthesis = "speechSynthesis" in window;
    if (!hasNativeSupportSynthesis) return;

    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = this.getFullLanguageCode(languageCode);
    utterance.rate = 0.8;

    window.speechSynthesis.speak(utterance);
  }

  updateDetectedLanguage(detectedLanguage) {
    const option = this.sourceLanguage?.querySelector(`option[value="${detectedLanguage}"]`);
    if (option) {
      const autoOption = this.sourceLanguage?.querySelector(`option[value="auto"]`);
      if (autoOption) {
        autoOption.textContent = `Detectar (${option.textContent})`;
      }
    }
  }

  async getTranslation(text) {
    const sourceLanguage = this.sourceLanguage?.value === 'auto'
      ? await this.detectLanguage(text)
      : this.sourceLanguage?.value;

    const targetLanguage = this.targetLanguage?.value;

    if (sourceLanguage === targetLanguage) return text;

    try {
      const status = await window.Translator.availability({
        sourceLanguage,
        targetLanguage
      });

      if (status === 'unavailable') {
        throw new Error(`Traducción de ${sourceLanguage} a ${targetLanguage} no disponible`);
      }
    } catch (error) {
      console.error(error);
      throw new Error(`Traducción de ${sourceLanguage} a ${targetLanguage} no disponible`);
    }

    const translatorKey = `${sourceLanguage}-${targetLanguage}`;

    try {
      if (!this.currentTranslator || this.currentTranslatorKey !== translatorKey) {
        this.currentTranslator = await window.Translator.create({
          sourceLanguage,
          targetLanguage
        });
      }

      this.currentTranslatorKey = translatorKey;
      const translation = await this.currentTranslator.translate(text);
      return translation;
    } catch (error) {
      console.error(error);
      return 'Error al traducir';
    }
  }

  async swapLanguages() {
    if (this.sourceLanguage?.value === 'auto') {
      const detectedLanguage = await this.detectLanguage(this.inputText?.value || 'hola');
      this.sourceLanguage.value = detectedLanguage;
    }

    const temporalLanguage = this.sourceLanguage?.value;
    if (this.sourceLanguage && this.targetLanguage) {
      this.sourceLanguage.value = this.targetLanguage.value;
      this.targetLanguage.value = temporalLanguage || '';
    }
  }

  getFullLanguageCode(languageCode) {
    return ChatTranslator.FULL_LANGUAGES_CODES[languageCode] ?? ChatTranslator.DEFAULT_SOURCE_LANGUAGE;
  }

  async startVoiceRecognition() {
    const hasNativeRecognitionSupport = "SpeechRecognition" in window || "webkitSpeechRecognition" in window;
    if (!hasNativeRecognitionSupport) return;

    const SpeechRecognition = window.SpeechRecognition ?? window.webkitSpeechRecognition;
    const recognition = new SpeechRecognition();

    recognition.continuous = false;
    recognition.interimResults = false;

    const language = this.sourceLanguage?.value === 'auto'
      ? ChatTranslator.DEFAULT_SOURCE_LANGUAGE
      : this.sourceLanguage?.value;

    recognition.lang = this.getFullLanguageCode(language || '');

    recognition.onstart = () => {
      if (this.micButton) {
        this.micButton.classList.add('bg-red-500', 'text-white');
      }
    };

    recognition.onend = () => {
      if (this.micButton) {
        this.micButton.classList.remove('bg-red-500', 'text-white');
      }
    };

    recognition.onresult = (event) => {
      const [{ transcript }] = event.results[0];
      if (this.inputText) {
        this.inputText.value = transcript;
        this.updateSendButton();
        this.autoResizeTextarea();
      }
    };

    recognition.onerror = (event) => {
      console.error('Error de reconocimiento de voz: ', event.error);
    };

    recognition.start();
  }

  async detectLanguage(text) {
    try {
      if (!this.currentDetector) {
        this.currentDetector = await window.LanguageDetector.create({
          expectedInputLanguages: ChatTranslator.SUPPORTED_LANGUAGES
        });
      }

      const results = await this.currentDetector.detect(text);
      const detectedLanguage = results[0]?.detectedLanguage;

      return detectedLanguage === 'und' ? ChatTranslator.DEFAULT_SOURCE_LANGUAGE : detectedLanguage;
    } catch (error) {
      console.error("No he podido averiguar el idioma: ", error);
      return ChatTranslator.DEFAULT_SOURCE_LANGUAGE;
    }
  }
}

// Inicializar el traductor cuando el DOM esté listo
document.addEventListener('DOMContentLoaded', () => {
  new ChatTranslator();
});
</script>

